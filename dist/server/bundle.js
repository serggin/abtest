(()=>{var e={509:(e,t,n)=>{function r(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}n(73).open("abtest.sqlite").then((function(e){i.init(e)})).catch((function(e){return console.error(e.message)}));var a,o,i=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}var t,n;return t=e,n=[{key:"init",value:function(t){e.db=t}},{key:"all",value:function(){return e.db.all("SELECT * FROM dates ORDER BY regdate")}},{key:"create",value:function(t){return e.db.run("INSERT OR REPLACE INTO dates(userid, regdate, lastdate) VALUES(?, ?, ?)",t.userid,t.regdate,t.lastdate)}},{key:"rollingRetention",value:function(t){var n="\nSELECT count(*) AS regs, count(iif(date(lastdate, 'unixepoch', '-".concat(t," day') >= date(regdate, 'unixepoch') , 1, null)) AS rets\nFROM dates WHERE date(regdate, 'unixepoch', 'localtime') <= date('now', '-").concat(t," day')\n    ");return e.db.get(n)}},{key:"deleteAll",value:function(){return e.db.run("DELETE FROM dates")}}],null&&r(t.prototype,null),n&&r(t,n),e}();o=void 0,"db"in(a=i)?Object.defineProperty(a,"db",{value:o,enumerable:!0,configurable:!0,writable:!0}):a.db=o,e.exports=i},305:e=>{"use strict";e.exports=require("regenerator-runtime/path")},835:e=>{"use strict";e.exports=require("regenerator-runtime/runtime")},73:e=>{"use strict";e.exports=require("sqlite-async")}},t={};function n(r){if(t[r])return t[r].exports;var a=t[r]={exports:{}};return e[r](a,a.exports,n),a.exports}n.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return n.d(t,{a:t}),t},n.d=(e,t)=>{for(var r in t)n.o(t,r)&&!n.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:t[r]})},n.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),(()=>{"use strict";const e=require("express");var t=n.n(e);const r=require("path");var a=n.n(r),o=n(509),i=n.n(o),u=function(e){var t=function(e){var t=/(\d\d)\.(\d\d)\.(\d\d\d\d)/.exec(e);if(t){var n=new Date(t[3],t[2]-1,t[1]);if(n.getFullYear()==t[3]&&n.getMonth()+1==t[2]&&n.getDate()==t[1])return n}return null}(e);return t?(t.getTime()/1e3).toFixed(0):0};function s(e,t,n,r,a,o,i){try{var u=e[o](i),s=u.value}catch(e){return void n(e)}u.done?t(s):Promise.resolve(s).then(r,a)}n(835),n(305).path;var c=a().join(__dirname,"../../"),l=t()();l.use(t().json()),l.use(t().static(a().join(c,"dist/client"))),l.get("/",(function(e,t){t.sendFile(a().join(c,"dist/client","index.html"))})),l.get("/dates",(function(e,t,n){i().all().then((function(e){t.status(200).json(e)}))})),l.post("/dates",(function(e,t,n){var r=e.body,a=[];r.forEach(function(){var e,t=(e=regeneratorRuntime.mark((function e(t){var n;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n={userid:t[0],regdate:u(t[1]),lastdate:u(t[2])},e.prev=1,e.next=4,i().create(n);case 4:e.next=10;break;case 6:e.prev=6,e.t0=e.catch(1),console.error("ERROR=",e.t0.message),a.push(e.t0.message);case 10:case"end":return e.stop()}}),e,null,[[1,6]])})),function(){var t=this,n=arguments;return new Promise((function(r,a){var o=e.apply(t,n);function i(e){s(o,r,a,i,u,"next",e)}function u(e){s(o,r,a,i,u,"throw",e)}i(void 0)}))});return function(e){return t.apply(this,arguments)}}()),a.length>0?t.status(500).json(a):t.sendStatus(201)})),l.get("/dates/rolling-retention/:day",(function(e,t,n){var r=parseInt(e.params.day);r>0?i().rollingRetention(r).then((function(e){var n=e.regs,r=e.rets;n>0?t.send((r/n*100).toFixed(0)):t.send("Not available")})).catch((function(e){t.status(500).send(e.message)})):t.status(422).send("Invalid xday parameter")})),l.delete("/dates",(function(e,t,n){i().deleteAll().then((function(){t.sendStatus(200)})).catch((function(e){t.status(500).send("Delete failed "+e.message)}))})),l.listen(8e3,(function(){return console.log("Listening on port ".concat(8e3,"!"))}))})()})();